<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kuis Online (DB-driven)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    .hidden { display: none; }
    button { padding: 10px 14px; border-radius: 6px; cursor: pointer; }
    .answer { display:block; margin:8px 0; }
  </style>
</head>
<body>
  <h1>Kuis Online â€” Hukum Bacaan Mim Mati</h1>

  <div id="loadingNotice">Memuat data... Harap tunggu.</div>

  <div id="welcomeScreen" class="hidden">
    <p>Masukkan NIS:</p>
    <input id="nisInput" />
    <div id="studentInfo" class="hidden"></div>
    <div style="margin-top:10px;">
      <button id="startBtn">Mulai Kuis</button>
    </div>
  </div>

  <div id="quizScreen" class="hidden">
    <h3 id="questionNumber">Soal 1</h3>
    <div id="questionText"></div>
    <div id="answersContainer"></div>
    <div style="margin-top:10px;">Score: <span id="currentScore">0</span></div>
  </div>

  <div id="resultsScreen" class="hidden">
    <h2>Hasil</h2>
    <div>Skor: <span id="finalScore"></span></div>
    <div>Benar: <span id="correctAnswers"></span></div>
    <div>Akurasi: <span id="accuracy"></span>%</div>
    <div style="margin-top:12px;"><button onclick="location.reload()">Mulai Lagi</button></div>
  </div>

<script>
  // ====== CONFIG ======
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyFSsINEu2QnJmmqyu-5KkoAGLI8Nh7urcdwUsdvCjaPDfWllHE58Miei5_gsRoUudV/exec";
  // ====================

  // App state
  let students = [];     // loaded from sheet
  let questions = [];    // loaded from sheet
  let player = null;
  let quizOrder = [];
  let currentQuestionIndex = 0;
  let score = 0;
  let correctCount = 0;

  // DOM
  const loadingNotice = document.getElementById('loadingNotice');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const nisInput = document.getElementById('nisInput');
  const studentInfo = document.getElementById('studentInfo');
  const startBtn = document.getElementById('startBtn');

  const quizScreen = document.getElementById('quizScreen');
  const questionNumber = document.getElementById('questionNumber');
  const questionText = document.getElementById('questionText');
  const answersContainer = document.getElementById('answersContainer');
  const currentScoreEl = document.getElementById('currentScore');

  const resultsScreen = document.getElementById('resultsScreen');
  const finalScoreEl = document.getElementById('finalScore');
  const correctAnswersEl = document.getElementById('correctAnswers');
  const accuracyEl = document.getElementById('accuracy');

  // ---- helper: insert JSONP script for GET requests ----
  function jsonpGet(type, callbackName) {
    const script = document.createElement('script');
    const url = WEBAPP_URL + '?type=' + encodeURIComponent(type) + '&callback=' + encodeURIComponent(callbackName);
    script.src = url;
    script.async = true;
    script.onerror = function() {
      console.error('Gagal memuat JSONP:', url);
      alert('Gagal memuat data dari server. Periksa koneksi dan pengaturan Web App.');
    };
    document.head.appendChild(script);
  }

  // Callbacks used by JSONP
  function handleStudents(data) {
    // data is array of objects with keys from header: NIS,Nama,Kelas
    if (Array.isArray(data)) {
      students = data.map(r => ({
        nis: String(r['NIS'] || r['nis'] || r['Nis'] || '').trim(),
        nama: r['Nama'] || r['nama'] || r['Name'] || '',
        kelas: r['Kelas'] || r['kelas'] || ''
      })).filter(s => s.nis);
    } else {
      students = [];
    }
    checkLoaded();
  }

  function handleQuestions(data) {
    // data is array of objects, keys: Soal,A,B,C,D,Kunci
    if (Array.isArray(data)) {
      questions = data.map(r => ({
        soal: r['Soal'] || r['soal'] || '',
        answers: [r['A']||r['a']||'', r['B']||r['b']||'', r['C']||r['c']||'', r['D']||r['d']||''],
        kunci: (r['Kunci'] || r['kunci'] || r['KUNCI'] || '').toString().trim()
      })).filter(q => q.soal);
    } else {
      questions = [];
    }
    checkLoaded();
  }

  // check if both loaded
  let loadedStudents = false, loadedQuestions = false;
  function checkLoaded() {
    // detect presence of data as proxies
    if (students.length >= 0) loadedStudents = true;
    if (questions.length >= 0) loadedQuestions = true;
    // both loaded (even if empty) then show UI
    if (loadedStudents && loadedQuestions) {
      loadingNotice.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
    }
  }

  // JSONP callbacks must be global
  window.handleStudents = handleStudents;
  window.handleQuestions = handleQuestions;

  // Start by loading students and questions via JSONP
  jsonpGet('students', 'handleStudents');
  jsonpGet('questions', 'handleQuestions');

  // ---- UI: check nis input ----
  nisInput.addEventListener('input', () => {
    const v = nisInput.value.trim();
    if (!v) { studentInfo.classList.add('hidden'); player = null; return; }
    const s = students.find(x => String(x.nis) === String(v));
    if (s) {
      player = s;
      studentInfo.innerHTML = '<strong>' + s.nama + '</strong><div>' + (s.kelas || '') + '</div>';
      studentInfo.classList.remove('hidden');
    } else {
      player = null;
      studentInfo.innerHTML = '<span style="color: red">NIS tidak ditemukan</span>';
      studentInfo.classList.remove('hidden');
    }
  });

  // start quiz
  startBtn.addEventListener('click', () => {
    if (!nisInput.value.trim()) { alert('Masukkan NIS'); return; }
    if (!player) { alert('NIS tidak valid'); return; }
    if (questions.length < 1) { alert('Belum ada soal di spreadsheet'); return; }

    // prepare quiz: shuffle questions (simple)
    quizOrder = shuffle(Array.from({length: questions.length}, (_,i)=>i)).slice(0, 20); // up to 20 soal
    currentQuestionIndex = 0;
    score = 0;
    correctCount = 0;

    welcomeScreen.classList.add('hidden');
    quizScreen.classList.remove('hidden');
    showQuestion();
  });

  function showQuestion() {
    const idx = quizOrder[currentQuestionIndex];
    const q = questions[idx];
    questionNumber.textContent = 'Soal ' + (currentQuestionIndex + 1) + '/' + quizOrder.length;
    questionText.innerHTML = q.soal;
    answersContainer.innerHTML = '';
    q.answers.forEach((ans, i) => {
      const b = document.createElement('button');
      b.className = 'answer';
      b.innerText = String.fromCharCode(65 + i) + '. ' + ans;
      b.onclick = () => selectAnswer(i);
      answersContainer.appendChild(b);
    });
  }

  function selectAnswer(choiceIndex) {
    const idx = quizOrder[currentQuestionIndex];
    const q = questions[idx];
    // determine correctness - support 'Kunci' like 'A' or 'C' or '3'
    let correct = -1;
    const k = (q.kunci || '').toString().trim().toUpperCase();
    if (k === 'A' || k === 'B' || k === 'C' || k === 'D') {
      correct = 'ABCD'.indexOf(k);
    } else if (!isNaN(Number(k))) {
      correct = Number(k); // if stored as 0/1/2/3
    }
    if (choiceIndex === correct) {
      correctCount++;
      score += 100; // simple scoring
    }
    currentQuestionIndex++;
    if (currentQuestionIndex >= quizOrder.length) {
      endQuiz();
    } else {
      showQuestion();
    }
    currentScoreEl.textContent = score;
  }

  function endQuiz() {
    quizScreen.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    finalScoreEl.textContent = score;
    correctAnswersEl.textContent = correctCount;
    const accuracy = Math.round((correctCount / quizOrder.length) * 100);
    accuracyEl.textContent = accuracy;

    // Build result
    const resultPayload = {
      nis: player.nis,
      nama: player.nama,
      kelas: player.kelas,
      skor: score,
      benar: correctCount,
      akurasi: accuracy,
      status: "Selesai",
      percobaan: 1,
      tanggal: new Date().toLocaleDateString('id-ID')
    };

    // POST hasil menggunakan no-cors (karena CORS)
    fetch(WEBAPP_URL, {
      method: 'POST',
      mode: 'no-cors', // bypass CORS preflight (note: response will be opaque)
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(resultPayload)
    }).catch(err => {
      console.warn('Pengiriman hasil gagal (network):', err);
    });
  }

  // simple fisher-yates shuffle
  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
</script>
</body>
</html>
