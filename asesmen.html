<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesmen Online Fikih - Sistem Terintegrasi Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); }
        .option-button { transition: all 0.2s ease; }
        .option-button:hover { transform: scale(1.02); }
        .selected { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .correct { background: linear-gradient(135deg, #10b981, #059669); }
        .incorrect { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .progress-bar { transition: width 0.5s ease; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="exam-title" class="text-2xl font-bold text-gray-800">Asesmen Online Fikih</h1>
                    <p id="exam-subtitle" class="text-gray-600">Sistem Terintegrasi Google Sheets</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Waktu Tersisa</div>
                    <div id="timer" class="text-xl font-bold text-blue-600">30:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">Progress</span>
                <span id="progress-text" class="text-sm text-gray-500">0 dari 0 soal</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Loading Screen -->
        <div id="loading-screen" class="max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <div class="loading w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Memuat Sistem Asesmen</h2>
                <p class="text-gray-600 mb-4">Menghubungkan ke Google Sheets...</p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-700 mb-2">
                        <strong>üìä Spreadsheet ID:</strong> 1LXjILS4HLHFlbzl2aIYDrBLKM4D4bp2PUnJBgk81RqU
                    </p>
                    <p class="text-sm text-blue-700">
                        <strong>üîó Apps Script URL:</strong> <span class="font-mono text-xs">AKfycbwJkSCNQCLERl0R01p5Jc59ehEVe2yQjd0EvrxbBRWmCFXip1JxzLsPf-3xPF_HSI71fg</span>
                    </p>
                </div>
                <div id="connection-status" class="mt-4 p-3 rounded-lg text-sm text-center hidden">
                    <span id="connection-message"></span>
                </div>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Siswa</h2>
                    <p class="text-gray-600">Masukkan No. Induk dan Password Anda</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Induk Siswa:</label>
                        <input type="text" id="login-student-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="Masukkan nomor induk">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                        <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="Masukkan password">
                    </div>
                    
                    <button onclick="loginStudent()" id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        üîê Login
                    </button>
                    
                    <div id="login-error" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Exam Selection Screen -->
        <div id="exam-selection-screen" class="hidden max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Pilih Ujian</h2>
                    <p class="text-gray-600">Selamat datang <span id="student-name-display" class="font-semibold text-blue-600"></span>! Pilih ujian yang tersedia untuk Anda.</p>
                </div>

                <div id="available-exams" class="space-y-4">
                    <!-- Available exams will be loaded here -->
                </div>

                <div id="no-exams" class="hidden text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Tidak Ada Ujian Aktif</h3>
                    <p class="text-gray-500 mb-6">Saat ini tidak ada ujian yang tersedia untuk kelas Anda.</p>
                    <button onclick="refreshExams()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="logoutStudent()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        ‚Üê Kembali ke Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div id="question-container" class="bg-white rounded-xl shadow-lg p-8 question-card">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="flex justify-between mt-6">
                    <button id="prev-btn" onclick="previousQuestion()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ‚Üê Sebelumnya
                    </button>
                    <button id="next-btn" onclick="nextQuestion()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Selanjutnya ‚Üí
                    </button>
                    <button id="finish-btn" onclick="finishQuiz()" class="hidden px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Selesai
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                    <div class="mb-6">
                        <div id="result-icon" class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center">
                            <!-- Icon will be set by JavaScript -->
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Asesmen Selesai!</h2>
                        <p id="result-message" class="text-gray-600"></p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 rounded-lg p-6">
                            <div class="text-3xl font-bold text-blue-600" id="total-score">0</div>
                            <div class="text-gray-600">Total Skor</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-6">
                            <div class="text-3xl font-bold text-green-600" id="correct-answers">0</div>
                            <div class="text-gray-600">Jawaban Benar</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-6">
                            <div class="text-3xl font-bold text-purple-600" id="percentage">0%</div>
                            <div class="text-gray-600">Persentase</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Rincian Hasil:</h3>
                        <div id="detailed-results" class="space-y-2">
                            <!-- Detailed results will be shown here -->
                        </div>
                    </div>

                    <div class="flex gap-4 justify-center">
                        <button onclick="saveResults()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            üíæ Simpan Hasil
                        </button>
                        <button onclick="restartQuiz()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            üîÑ Kembali ke Login
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="loading w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p id="loading-text" class="text-gray-700">Memuat data...</p>
        </div>
    </div>

    <script>
        // Global Variables - Konfigurasi Langsung
        let systemConfig = {
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycbwJkSCNQCLERl0R01p5Jc59ehEVe2yQjd0EvrxbBRWmCFXip1JxzLsPf-3xPF_HSI71fg/exec',
            spreadsheetId: '1LXjILS4HLHFlbzl2aIYDrBLKM4D4bp2PUnJBgk81RqU'
        };
        let currentStudent = null;
        let currentExam = null;
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timeLeft = 1800; // 30 minutes
        let timerInterval;

        // System Initialization - Auto Start
        async function initializeSystem() {
            console.log('üöÄ Starting system initialization...');
            console.log('üìä Apps Script URL:', systemConfig.appsScriptUrl);
            console.log('üìã Spreadsheet ID:', systemConfig.spreadsheetId);
            
            try {
                // Test connection first
                console.log('üîç Testing Google Sheets connection...');
                await testConnection();
                
                console.log('‚úÖ Connection test passed, loading data...');
                
                // Load data from Google Sheets
                await loadStudentsData();
                await loadExamsData();
                await loadSettingsData();
                
                console.log('‚úÖ Google Sheets connection successful');
                
                // Show login screen after successful loading
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // Show success notification
                setTimeout(() => {
                    alert('‚úÖ Koneksi Google Sheets Berhasil!\n\nSistem telah terhubung dengan database.\nSilakan login dengan akun Anda.');
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Google Sheets connection failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    url: systemConfig.appsScriptUrl
                });
                
                // Initialize demo mode as fallback
                initializeDemoMode();
                
                // Show detailed error notification
                setTimeout(() => {
                    alert(`‚ùå Koneksi Google Sheets Gagal!\n\nError: ${error.message}\n\nüéÆ Mode Demo Aktif!\n\nüîë Login Demo:\n‚Ä¢ No. Induk: 001, Password: test123 (Kelas 5A)\n‚Ä¢ No. Induk: 002, Password: test456 (Kelas 5A)\n‚Ä¢ No. Induk: 003, Password: test789 (Kelas 5B)\n\nüîß Periksa:\n1. Apps Script URL sudah benar?\n2. Spreadsheet ID sudah benar?\n3. Apps Script sudah di-deploy?`);
                }, 1000);
                
                // Show login screen
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        function initializeDemoMode() {
            // Initialize demo data
            initializeSampleQuestions();
            
            // Set demo students data
            window.studentsData = [
                { noInduk: '001', nama: 'Ahmad Fauzi', kelas: '5A', password: 'test123', status: 'aktif' },
                { noInduk: '002', nama: 'Siti Aminah', kelas: '5A', password: 'test456', status: 'aktif' },
                { noInduk: '003', nama: 'Muhammad Ali', kelas: '5B', password: 'test789', status: 'aktif' }
            ];
            
            // Update title from demo settings
            updateAppTitleFromDemo();
        }

        function updateAppTitleFromDemo() {
            // Update title from demo active exams
            if (window.sampleExams && window.sampleExams.length > 0) {
                const activeExam = window.sampleExams.find(exam => exam.status === 'aktif') || window.sampleExams[0];
                
                // App title from namaUjian + mapel
                const appTitle = `${activeExam.namaUjian} - ${activeExam.mapel}`;
                document.getElementById('exam-title').textContent = appTitle;
                
                // Subtitle from materi
                document.getElementById('exam-subtitle').textContent = activeExam.materi;
                
                console.log('Demo title updated from active exam:', appTitle, '|', activeExam.materi);
            } else if (window.examSettings && Object.keys(window.examSettings).length > 0) {
                const firstExamId = Object.keys(window.examSettings)[0];
                const firstExam = window.examSettings[firstExamId];
                
                const appTitle = `${firstExam.namaUjian} - ${firstExam.mapel}`;
                document.getElementById('exam-title').textContent = appTitle;
                document.getElementById('exam-subtitle').textContent = firstExam.materi;
                
                console.log('Demo title updated from exam settings');
            }
        }

        function initializeSampleQuestions() {
            // Sample exam settings from Settings sheet
            window.examSettings = {
                'UJ001': {
                    namaUjian: 'Ulangan Harian Infak',
                    mapel: 'Fikih',
                    kelas: '5A',
                    materi: 'Infak dan Sedekah'
                },
                'UJ002': {
                    namaUjian: 'Quiz Zakat',
                    mapel: 'Fikih', 
                    kelas: '5B',
                    materi: 'Zakat Fitrah dan Zakat Mal'
                }
            };

            // Sample questions for demo
            window.sampleExams = [
                {
                    ujianId: 'UJ001',
                    namaUjian: 'Ulangan Harian Infak',
                    mapel: 'Fikih',
                    kelas: '5A',
                    materi: 'Infak dan Sedekah',
                    waktuMenit: 30,
                    tanggalMulai: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                    tanggalSelesai: new Date(Date.now() + 3600000).toISOString(), // 1 hour from now
                    status: 'aktif'
                },
                {
                    ujianId: 'UJ002',
                    namaUjian: 'Quiz Zakat',
                    mapel: 'Fikih',
                    kelas: '5B',
                    materi: 'Zakat Fitrah dan Zakat Mal',
                    waktuMenit: 20,
                    tanggalMulai: new Date(Date.now() - 3600000).toISOString(),
                    tanggalSelesai: new Date(Date.now() + 3600000).toISOString(),
                    status: 'aktif'
                }
            ];

            window.sampleQuestions = {
                'UJ001': [
                    {
                        type: 'multipleChoice',
                        question: 'Anjuran bagi orang yang memiliki kelebihan harta untuk dirinya dan orang yang ditanggung adalah ‚Ä¶.',
                        options: ['berpuasa', 'salat', 'berniaga', 'infak'],
                        correct: 3,
                        points: 1
                    },
                    {
                        type: 'fillInBlank',
                        question: 'Infak berasal dari kata nafaqa, yang artinya ‚Ä¶.',
                        correct: ['menafkah', 'membelanjakan harta', 'mengeluarkan'],
                        points: 1
                    },
                    {
                        type: 'multipleChoice',
                        question: 'Hukum infak dalam Islam adalah ‚Ä¶.',
                        options: ['wajib', 'sunnah', 'mubah', 'makruh'],
                        correct: 1,
                        points: 1
                    },
                    {
                        type: 'multipleChoiceComplex',
                        question: 'Yang termasuk adab berinfak adalah ‚Ä¶ (pilih lebih dari satu)',
                        options: ['ikhlas', 'riya', 'tidak menyakiti', 'sombong'],
                        correct: [0, 2],
                        points: 2
                    }
                ],
                'UJ002': [
                    {
                        type: 'multipleChoice',
                        question: 'Zakat fitrah wajib dikeluarkan pada bulan ‚Ä¶.',
                        options: ['Ramadan', 'Syawal', 'Dzulhijjah', 'Muharram'],
                        correct: 0,
                        points: 1
                    },
                    {
                        type: 'fillInBlank',
                        question: 'Nisab zakat emas adalah ‚Ä¶ gram.',
                        correct: ['85', '85 gram'],
                        points: 1
                    }
                ]
            };
        }



        // Connection Status Functions
        function updateConnectionStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connection-status');
            const messageSpan = document.getElementById('connection-message');
            
            statusDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            
            switch(type) {
                case 'success':
                    statusDiv.classList.add('bg-green-100', 'text-green-700');
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-100', 'text-red-700');
                    break;
                default:
                    statusDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
            
            messageSpan.textContent = message;
        }

        // Connection Test Function
        async function testConnection() {
            console.log('üîó Testing connection to Apps Script...');
            updateConnectionStatus('üîç Testing connection...', 'info');
            
            const response = await fetch(systemConfig.appsScriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    action: 'test',
                    spreadsheetId: systemConfig.spreadsheetId
                })
            });
            
            console.log('üì° Response status:', response.status);
            console.log('üì° Response ok:', response.ok);
            
            if (!response.ok) {
                updateConnectionStatus(`‚ùå HTTP Error: ${response.status} ${response.statusText}`, 'error');
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì° Response data:', data);
            
            if (!data.success) {
                updateConnectionStatus(`‚ùå ${data.error || 'Connection test failed'}`, 'error');
                throw new Error(data.error || 'Connection test failed');
            }
            
            updateConnectionStatus('‚úÖ Connection successful!', 'success');
            console.log('‚úÖ Connection test successful');
            return data;
        }

        // Data Loading Functions
        async function loadStudentsData() {
            try {
                console.log('üìö Loading students data...');
                
                const response = await fetch(systemConfig.appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getStudents',
                        spreadsheetId: systemConfig.spreadsheetId
                    })
                });
                
                console.log('üìö Students response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìö Students response data:', data);
                
                if (data.success && data.students) {
                    window.studentsData = data.students;
                    console.log('‚úÖ Students data loaded successfully:', data.students.length, 'students');
                } else {
                    throw new Error(data.error || 'Failed to load students data');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading students data:', error);
                throw error;
            }
        }

        async function loadExamsData() {
            try {
                console.log('üìù Loading exams data...');
                
                const response = await fetch(systemConfig.appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getActiveExams',
                        spreadsheetId: systemConfig.spreadsheetId
                    })
                });
                
                console.log('üìù Exams response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìù Exams response data:', data);
                
                if (data.success && data.exams) {
                    window.sampleExams = data.exams;
                    console.log('‚úÖ Exams data loaded successfully:', data.exams.length, 'exams');
                } else {
                    throw new Error(data.error || 'Failed to load exams data');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading exams data:', error);
                throw error;
            }
        }

        async function loadSettingsData() {
            try {
                console.log('‚öôÔ∏è Loading settings data...');
                
                const response = await fetch(systemConfig.appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getSettings',
                        spreadsheetId: systemConfig.spreadsheetId
                    })
                });
                
                console.log('‚öôÔ∏è Settings response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚öôÔ∏è Settings response data:', data);
                
                if (data.success && data.settings) {
                    window.examSettings = data.settings;
                    console.log('‚úÖ Settings data loaded successfully:', data.settings);
                    
                    // Update app title and subtitle - will use active exam data if available
                    updateAppTitle(data.settings);
                    
                } else {
                    throw new Error(data.error || 'Failed to load settings data');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading settings data:', error);
                throw error;
            }
        }

        function updateAppTitle(settings) {
            // Try to get title from active exams first
            if (window.sampleExams && window.sampleExams.length > 0) {
                const activeExam = window.sampleExams.find(exam => exam.status === 'aktif') || window.sampleExams[0];
                
                // App title from namaUjian + mapel
                const appTitle = `${activeExam.namaUjian} - ${activeExam.mapel}`;
                document.getElementById('exam-title').textContent = appTitle;
                console.log('App title updated from active exam:', appTitle);
                
                // Subtitle from materi
                document.getElementById('exam-subtitle').textContent = activeExam.materi;
                console.log('App subtitle updated from active exam:', activeExam.materi);
                
                return; // Exit early since we found active exam data
            }
            
            // Fallback to Settings sheet if available
            if (settings.appTitle) {
                document.getElementById('exam-title').textContent = settings.appTitle;
                console.log('App title updated from settings:', settings.appTitle);
            }
            
            if (settings.appSubtitle) {
                document.getElementById('exam-subtitle').textContent = settings.appSubtitle;
                console.log('App subtitle updated from settings:', settings.appSubtitle);
            }
        }

        async function loadQuestionsData(examId) {
            try {
                const response = await fetch(systemConfig.appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getQuestions',
                        spreadsheetId: systemConfig.spreadsheetId,
                        examId: examId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                if (data.success && data.questions) {
                    allQuestions = data.questions;
                    
                    // Get exam settings from loaded data
                    if (window.examSettings && window.examSettings[examId]) {
                        currentExam = window.examSettings[examId];
                    }
                    
                    // Set timer based on exam settings
                    timeLeft = (currentExam.waktuMenit || 30) * 60;
                    
                    // Initialize user answers array
                    userAnswers = new Array(allQuestions.length).fill(null);
                    
                    console.log('Questions loaded successfully:', allQuestions.length, 'questions');
                } else {
                    throw new Error(data.error || 'Failed to load questions');
                }
                
            } catch (error) {
                console.error('Error loading questions:', error);
                throw error;
            }
        }

        // Login Functions
        async function loginStudent() {
            const studentId = document.getElementById('login-student-id').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!studentId || !password) {
                showLoginError('Harap isi No. Induk dan Password');
                return;
            }
            
            showLoading('Memverifikasi login...');
            
            try {
                // Ensure studentsData is available
                if (!window.studentsData || !Array.isArray(window.studentsData)) {
                    throw new Error('Data siswa belum dimuat');
                }
                
                // Find student in loaded data
                const student = window.studentsData.find(s => 
                    s.noInduk === studentId && s.password === password && s.status === 'aktif'
                );
                
                if (!student) {
                    hideLoading();
                    showLoginError('No. Induk atau Password salah');
                    return;
                }
                
                currentStudent = student;
                hideLoading();
                
                // Show exam selection screen
                showExamSelection();
                
            } catch (error) {
                hideLoading();
                showLoginError('Terjadi kesalahan saat login: ' + error.message);
            }
        }

        async function showExamSelection() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exam-selection-screen').classList.remove('hidden');
            
            // Display student name
            document.getElementById('student-name-display').textContent = currentStudent.nama;
            
            showLoading('Memuat ujian yang tersedia...');
            
            try {
                // Use sample exams for demo
                const activeExams = window.sampleExams.filter(exam => {
                    const allowedClasses = exam.kelas.split(',').map(k => k.trim());
                    return allowedClasses.includes(currentStudent.kelas) && exam.status === 'aktif';
                });
                
                hideLoading();
                displayAvailableExams(activeExams);
                
            } catch (error) {
                hideLoading();
                alert('Gagal memuat ujian: ' + error.message);
            }
        }

        async function displayAvailableExams(exams) {
            const container = document.getElementById('available-exams');
            const noExamsDiv = document.getElementById('no-exams');
            
            if (exams.length === 0) {
                container.classList.add('hidden');
                noExamsDiv.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noExamsDiv.classList.add('hidden');
            
            let html = '';
            
            for (const exam of exams) {
                // Check if student has already completed this exam
                const hasCompleted = await checkQuizCompletion(currentStudent.noInduk, exam.ujianId);
                
                const startTime = new Date(exam.tanggalMulai).toLocaleString('id-ID');
                const endTime = new Date(exam.tanggalSelesai).toLocaleString('id-ID');
                
                html += `
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">${exam.namaUjian}</h3>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path>
                                        </svg>
                                        <span><strong>Mata Pelajaran:</strong> ${exam.mapel}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                        <span><strong>Kelas:</strong> ${exam.kelas}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span><strong>Materi:</strong> ${exam.materi}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span><strong>Waktu:</strong> ${exam.waktuMenit} menit</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span><strong>Periode:</strong> ${startTime} - ${endTime}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ml-6">
                                ${hasCompleted ? 
                                    `<div class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">
                                        ‚úÖ Sudah Dikerjakan
                                    </div>` :
                                    `<button onclick="startExam('${exam.ujianId}')" 
                                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                        üöÄ Mulai Ujian
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function startExam(examId) {
            showLoading('Memuat soal ujian...');
            
            try {
                // Try to load questions from Google Sheets first
                try {
                    await loadQuestionsData(examId);
                } catch (error) {
                    console.warn('Failed to load from Google Sheets, using demo data:', error);
                    
                    // Fallback to demo data
                    currentExam = window.sampleExams.find(exam => exam.ujianId === examId);
                    if (!currentExam) {
                        throw new Error('Ujian tidak ditemukan');
                    }
                    
                    allQuestions = window.sampleQuestions[examId] || [];
                    
                    if (allQuestions.length === 0) {
                        throw new Error('Tidak ada soal yang tersedia untuk ujian ini');
                    }
                    
                    // Set timer based on exam settings
                    timeLeft = (currentExam.waktuMenit || 30) * 60;
                    
                    // Initialize user answers array
                    userAnswers = new Array(allQuestions.length).fill(null);
                }
                
                // Update header with exam information
                updateExamHeader(examId);
                
                hideLoading();
                startQuiz();
                
            } catch (error) {
                hideLoading();
                alert('Gagal memuat soal: ' + error.message);
            }
        }

        function updateExamHeader(examId) {
            const settings = window.examSettings[examId];
            if (settings) {
                const titleElement = document.getElementById('exam-title');
                const subtitleElement = document.getElementById('exam-subtitle');
                
                titleElement.textContent = `${settings.namaUjian} - ${settings.mapel} - ${settings.kelas}`;
                subtitleElement.textContent = settings.materi;
            }
        }

        function refreshExams() {
            showExamSelection();
        }

        function logoutStudent() {
            currentStudent = null;
            currentExam = null;
            document.getElementById('exam-selection-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('login-student-id').value = '';
            document.getElementById('login-password').value = '';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        async function checkQuizCompletion(studentId, examId) {
            try {
                // For demo, check localStorage for completed exams
                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                const key = `${studentId}_${examId}`;
                return completedExams.includes(key);
            } catch (error) {
                console.error('Error checking completion:', error);
                return false;
            }
        }

        // Quiz Functions
        function startQuiz() {
            document.getElementById('exam-selection-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            // Update progress text
            document.getElementById('progress-text').textContent = `0 dari ${allQuestions.length} soal`;
            
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function displayQuestion() {
            const question = allQuestions[currentQuestionIndex];
            const container = document.getElementById('question-container');
            
            let html = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            ${getQuestionTypeLabel(question.type)}
                        </span>
                        <span class="text-gray-500 text-sm">
                            Soal ${currentQuestionIndex + 1} dari ${allQuestions.length}
                        </span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">${question.question}</h3>
                </div>
            `;

            switch (question.type) {
                case 'multipleChoice':
                    html += renderMultipleChoice(question);
                    break;
                case 'multipleChoiceComplex':
                    html += renderMultipleChoiceComplex(question);
                    break;
                case 'matching':
                    html += renderMatching(question);
                    break;
                case 'fillInBlank':
                    html += renderFillInBlank(question);
                    break;
            }

            container.innerHTML = html;
            updateProgress();
            updateNavigationButtons();
        }

        function getQuestionTypeLabel(type) {
            const labels = {
                'multipleChoice': 'Pilihan Ganda',
                'multipleChoiceComplex': 'Pilihan Ganda Kompleks',
                'matching': 'Menjodohkan',
                'fillInBlank': 'Isian Singkat'
            };
            return labels[type];
        }

        function renderMultipleChoice(question) {
            let html = '<div class="space-y-3">';
            question.options.forEach((option, index) => {
                const isSelected = userAnswers[currentQuestionIndex] === index;
                html += `
                    <button onclick="selectMultipleChoice(${index})" 
                            class="option-button w-full text-left p-4 border-2 rounded-lg transition-all ${
                                isSelected ? 'selected text-white border-blue-500' : 'border-gray-200 hover:border-blue-300'
                            }">
                        <span class="font-medium">${String.fromCharCode(97 + index)}.</span> ${option}
                    </button>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderMultipleChoiceComplex(question) {
            let html = '<div class="space-y-3">';
            html += '<p class="text-sm text-blue-600 font-medium mb-4">üí° Anda dapat memilih lebih dari satu jawaban!</p>';
            
            question.options.forEach((option, index) => {
                const isSelected = userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].includes(index);
                html += `
                    <button onclick="toggleMultipleChoiceComplex(${index})" 
                            class="option-button w-full text-left p-4 border-2 rounded-lg transition-all ${
                                isSelected ? 'selected text-white border-blue-500' : 'border-gray-200 hover:border-blue-300'
                            }">
                        <span class="font-medium">${String.fromCharCode(97 + index)}.</span> ${option}
                    </button>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderMatching(question) {
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            
            // Left column
            html += '<div class="space-y-3">';
            html += '<h4 class="font-semibold text-gray-700 mb-3">Pernyataan:</h4>';
            question.leftItems.forEach((item, index) => {
                html += `
                    <div class="p-3 bg-blue-50 rounded-lg border">
                        <span class="font-medium text-blue-800">${index + 1}.</span> ${item}
                    </div>
                `;
            });
            html += '</div>';

            // Right column
            html += '<div class="space-y-3">';
            html += '<h4 class="font-semibold text-gray-700 mb-3">Pilihan Jawaban:</h4>';
            question.rightItems.forEach((item, index) => {
                html += `
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <span class="font-medium text-gray-800">${String.fromCharCode(97 + index)}.</span> ${item}
                    </div>
                `;
            });
            html += '</div>';
            html += '</div>';

            // Matching inputs
            html += '<div class="mt-6">';
            html += '<h4 class="font-semibold text-gray-700 mb-3">Jawaban Anda:</h4>';
            html += '<div class="grid grid-cols-1 md:grid-cols-5 gap-4">';
            
            question.leftItems.forEach((_, index) => {
                const currentAnswer = userAnswers[currentQuestionIndex] ? userAnswers[currentQuestionIndex][index] : '';
                html += `
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${index + 1}</label>
                        <select onchange="updateMatching(${index}, this.value)" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih...</option>
                            ${question.rightItems.map((_, i) => 
                                `<option value="${i}" ${currentAnswer == i ? 'selected' : ''}>${String.fromCharCode(97 + i)}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            });
            html += '</div></div>';
            
            return html;
        }

        function renderFillInBlank(question) {
            const currentAnswer = userAnswers[currentQuestionIndex] || '';
            return `
                <div class="space-y-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <p class="text-sm text-yellow-800">üí° Isilah dengan jawaban yang tepat dan singkat!</p>
                    </div>
                    <input type="text" 
                           value="${currentAnswer}"
                           onchange="updateFillInBlank(this.value)"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                           placeholder="Ketik jawaban Anda di sini...">
                </div>
            `;
        }

        // Answer handling functions
        function selectMultipleChoice(optionIndex) {
            userAnswers[currentQuestionIndex] = optionIndex;
            displayQuestion();
        }

        function toggleMultipleChoiceComplex(optionIndex) {
            if (!userAnswers[currentQuestionIndex]) {
                userAnswers[currentQuestionIndex] = [];
            }
            
            const answers = userAnswers[currentQuestionIndex];
            const index = answers.indexOf(optionIndex);
            
            if (index > -1) {
                answers.splice(index, 1);
            } else {
                answers.push(optionIndex);
            }
            
            displayQuestion();
        }

        function updateMatching(questionIndex, value) {
            if (!userAnswers[currentQuestionIndex]) {
                userAnswers[currentQuestionIndex] = new Array(allQuestions[currentQuestionIndex].leftItems.length).fill('');
            }
            userAnswers[currentQuestionIndex][questionIndex] = value;
        }

        function updateFillInBlank(value) {
            userAnswers[currentQuestionIndex] = value.trim();
        }

        // Navigation functions
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < allQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === allQuestions.length - 1) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
            }
        }

        function updateProgress() {
            const answered = userAnswers.filter(answer => answer !== null && answer !== '' && answer !== undefined).length;
            const percentage = (answered / allQuestions.length) * 100;
            
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${answered} dari ${allQuestions.length} soal`;
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            calculateResults();
            showResults();
        }

        function calculateResults() {
            let totalScore = 0;
            let correctAnswers = 0;
            let maxScore = 0;

            allQuestions.forEach((question, index) => {
                maxScore += question.points;
                const userAnswer = userAnswers[index];
                let isCorrect = false;

                switch (question.type) {
                    case 'multipleChoice':
                        isCorrect = userAnswer === question.correct;
                        break;
                    case 'multipleChoiceComplex':
                        if (userAnswer && Array.isArray(userAnswer) && Array.isArray(question.correct)) {
                            const sortedUser = [...userAnswer].sort();
                            const sortedCorrect = [...question.correct].sort();
                            isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                        }
                        break;
                    case 'matching':
                        if (userAnswer && Array.isArray(userAnswer)) {
                            isCorrect = userAnswer.every((answer, i) => parseInt(answer) === question.correct[i]);
                        }
                        break;
                    case 'fillInBlank':
                        if (userAnswer && typeof userAnswer === 'string') {
                            const normalizedAnswer = userAnswer.toLowerCase().trim();
                            isCorrect = question.correct.some(correct => 
                                correct.toLowerCase().trim() === normalizedAnswer
                            );
                        }
                        break;
                }

                if (isCorrect) {
                    totalScore += question.points;
                    correctAnswers++;
                }
            });

            window.quizResults = {
                student: currentStudent,
                totalScore,
                maxScore,
                correctAnswers,
                totalQuestions: allQuestions.length,
                percentage: Math.round((totalScore / maxScore) * 100),
                timeSpent: 1800 - timeLeft,
                answers: userAnswers,
                questions: allQuestions,
                timestamp: new Date().toISOString()
            };
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            const results = window.quizResults;
            
            // Update result display
            document.getElementById('total-score').textContent = `${results.totalScore}/${results.maxScore}`;
            document.getElementById('correct-answers').textContent = `${results.correctAnswers}/${results.totalQuestions}`;
            document.getElementById('percentage').textContent = `${results.percentage}%`;

            // Set result icon and message
            const resultIcon = document.getElementById('result-icon');
            const resultMessage = document.getElementById('result-message');
            
            if (results.percentage >= 80) {
                resultIcon.className = 'w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-100';
                resultIcon.innerHTML = '<svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                resultMessage.textContent = `Excellent ${results.student.nama}! Pemahaman Anda tentang materi Infak sangat baik!`;
            } else if (results.percentage >= 60) {
                resultIcon.className = 'w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center bg-yellow-100';
                resultIcon.innerHTML = '<svg class="w-12 h-12 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
                resultMessage.textContent = `Good ${results.student.nama}! Anda sudah memahami sebagian besar materi, tingkatkan lagi ya!`;
            } else {
                resultIcon.className = 'w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center bg-red-100';
                resultIcon.innerHTML = '<svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                resultMessage.textContent = `${results.student.nama}, perlu belajar lebih giat lagi. Jangan menyerah, terus semangat!`;
            }

            // Show detailed results
            showDetailedResults();
        }

        function showDetailedResults() {
            const results = window.quizResults;
            const container = document.getElementById('detailed-results');
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">';
            
            // Group by question type
            const typeGroups = {
                'multipleChoice': { name: 'Pilihan Ganda', questions: [] },
                'multipleChoiceComplex': { name: 'Pilihan Ganda Kompleks', questions: [] },
                'matching': { name: 'Menjodohkan', questions: [] },
                'fillInBlank': { name: 'Isian Singkat', questions: [] }
            };

            results.questions.forEach((question, index) => {
                const userAnswer = results.answers[index];
                let isCorrect = false;

                switch (question.type) {
                    case 'multipleChoice':
                        isCorrect = userAnswer === question.correct;
                        break;
                    case 'multipleChoiceComplex':
                        if (userAnswer && Array.isArray(userAnswer)) {
                            const sortedUser = [...userAnswer].sort();
                            const sortedCorrect = [...question.correct].sort();
                            isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                        }
                        break;
                    case 'matching':
                        if (userAnswer && Array.isArray(userAnswer)) {
                            isCorrect = userAnswer.every((answer, i) => parseInt(answer) === question.correct[i]);
                        }
                        break;
                    case 'fillInBlank':
                        if (userAnswer && typeof userAnswer === 'string') {
                            const normalizedAnswer = userAnswer.toLowerCase().trim();
                            isCorrect = question.correct.some(correct => 
                                correct.toLowerCase().trim() === normalizedAnswer
                            );
                        }
                        break;
                }

                typeGroups[question.type].questions.push({
                    index: index + 1,
                    isCorrect,
                    points: question.points
                });
            });

            Object.values(typeGroups).forEach(group => {
                if (group.questions.length > 0) {
                    const correct = group.questions.filter(q => q.isCorrect).length;
                    const total = group.questions.length;
                    const totalPoints = group.questions.reduce((sum, q) => sum + (q.isCorrect ? q.points : 0), 0);
                    const maxPoints = group.questions.reduce((sum, q) => sum + q.points, 0);
                    
                    html += `
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-2">${group.name}</h4>
                            <div class="text-gray-600">
                                <div>Benar: ${correct}/${total}</div>
                                <div>Poin: ${totalPoints}/${maxPoints}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function saveResults() {
            const results = window.quizResults;
            
            showLoading('Menyimpan hasil...');
            
            try {
                // Try to save to Google Sheets first
                try {
                    const response = await fetch(systemConfig.appsScriptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'saveResults',
                            spreadsheetId: systemConfig.spreadsheetId,
                            timestamp: new Date().toLocaleString('id-ID'),
                            ujianId: currentExam.ujianId,
                            namaUjian: currentExam.namaUjian,
                            noInduk: results.student.noInduk,
                            nama: results.student.nama,
                            kelas: results.student.kelas,
                            totalSkor: results.totalScore,
                            skorMaksimal: results.maxScore,
                            persentase: results.percentage,
                            jawabanBenar: results.correctAnswers,
                            totalSoal: results.totalQuestions,
                            waktuPengerjaan: Math.floor(results.timeSpent / 60) + ' menit ' + (results.timeSpent % 60) + ' detik',
                            detailJawaban: JSON.stringify(results.answers)
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log('Results saved to Google Sheets successfully');
                        } else {
                            throw new Error(data.error || 'Failed to save to Google Sheets');
                        }
                    } else {
                        throw new Error('Network error');
                    }
                    
                } catch (error) {
                    console.warn('Failed to save to Google Sheets, saving locally:', error);
                    
                    // Fallback to localStorage
                    const savedResults = JSON.parse(localStorage.getItem('examResults') || '[]');
                    const resultData = {
                        timestamp: new Date().toLocaleString('id-ID'),
                        ujianId: currentExam.ujianId,
                        namaUjian: currentExam.namaUjian,
                        noInduk: results.student.noInduk,
                        nama: results.student.nama,
                        kelas: results.student.kelas,
                        totalSkor: results.totalScore,
                        skorMaksimal: results.maxScore,
                        persentase: results.percentage,
                        jawabanBenar: results.correctAnswers,
                        totalSoal: results.totalQuestions,
                        waktuPengerjaan: Math.floor(results.timeSpent / 60) + ' menit ' + (results.timeSpent % 60) + ' detik',
                        detailJawaban: JSON.stringify(results.answers)
                    };
                    
                    savedResults.push(resultData);
                    localStorage.setItem('examResults', JSON.stringify(savedResults));
                }
                
                // Mark exam as completed
                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                const key = `${results.student.noInduk}_${currentExam.ujianId}`;
                if (!completedExams.includes(key)) {
                    completedExams.push(key);
                    localStorage.setItem('completedExams', JSON.stringify(completedExams));
                }
                
                hideLoading();
                alert(`‚úÖ Hasil berhasil disimpan!\n\nUjian: ${currentExam.namaUjian}\nNama: ${results.student.nama}\nSkor: ${results.totalScore}/${results.maxScore} (${results.percentage}%)\n\nTerima kasih telah mengerjakan ujian!`);
                
            } catch (error) {
                hideLoading();
                alert('‚ùå Gagal menyimpan hasil: ' + error.message);
            }
        }

        function restartQuiz() {
            // Reset all variables
            currentQuestionIndex = 0;
            userAnswers = [];
            timeLeft = 1800;
            currentStudent = null;
            currentExam = null;
            
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Reset displays
            document.getElementById('login-student-id').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('timer').textContent = '30:00';
            document.getElementById('progress-bar').style.width = '0%';
            
            // Reset header to default
            document.getElementById('exam-title').textContent = 'Asesmen Online Fikih';
            document.getElementById('exam-subtitle').textContent = 'Sistem Terintegrasi Google Sheets';
            
            // Show login screen
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }



        // Utility Functions
        function showLoading(message) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-initialize system on page load
            setTimeout(() => {
                initializeSystem();
            }, 2000); // 2 second delay to show loading screen
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d5663bd04efe8a',t:'MTc1NDg5MDgzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
