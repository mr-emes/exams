<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        accent: '#F59E0B'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 0.3s ease; }
        .question-card { transition: all 0.3s ease; }
        .option-hover:hover { transform: translateX(4px); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full overflow-hidden mx-auto mb-4 border-4 border-primary shadow-lg">
                    <img src="https://i.imgur.com/0Laf7Zu.png" alt="MIN Singkawang Logo" class="w-full h-full object-cover" onerror="this.src=''; this.alt='Logo failed to load'; this.style.display='none';">
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">MIN SINGKAWANG</h1>
                <p class="text-gray-600 font-medium">Madrasah Maju, Bermutu, Mendunia</p>
            </div>
            
            <form id="loginFormElement" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
                    <input type="text" id="userId" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200"
                           placeholder="Masukkan User ID">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200"
                           placeholder="Masukkan Password">
                </div>
                
                <div id="connectionStatus" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        <div class="text-sm text-blue-800">
                            <div class="font-medium">Memeriksa Koneksi Database...</div>
                            <div>Sedang menguji koneksi ke Google Sheets</div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-6 rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                    Masuk
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
        </div>
    </div>

    <!-- Quiz Interface -->
    <div id="quizInterface" class="hidden min-h-screen p-4">
        <!-- Header -->
        <div class="bg-white rounded-2xl card-shadow p-6 mb-6 animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 id="examTitle" class="text-2xl font-bold text-gray-800 mb-2">Nama Ujian - Mapel - Kelas</h1>
                    <p id="examSubtitle" class="text-gray-600">Materi Ujian</p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary" id="timer">00:00</div>
                        <div class="text-sm text-gray-500">Waktu Tersisa</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-accent" id="questionCounter">1/20</div>
                        <div class="text-sm text-gray-500">Soal</div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Progress</span>
                    <span id="progressText">5%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-gradient-to-r from-primary to-accent h-2 rounded-full progress-bar" style="width: 5%"></div>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="bg-white rounded-2xl card-shadow p-8 mb-6 animate-fade-in question-card">
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-medium mr-3" id="questionType">Pilihan Ganda</span>
                    <span class="text-gray-500 text-sm" id="questionNumber">Soal 1</span>
                </div>
                <h2 id="questionText" class="text-xl font-semibold text-gray-800 leading-relaxed">
                    Pertanyaan akan muncul di sini...
                </h2>
            </div>
            
            <div id="optionsContainer" class="space-y-3">
                <!-- Options will be populated here -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
            <div class="flex justify-between items-center">
                <button id="prevBtn" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚Üê Sebelumnya
                </button>
                
                <div class="flex space-x-3">
                    <button id="markBtn" class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-200">
                        üè∑Ô∏è Tandai
                    </button>
                    <button id="nextBtn" class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                        Selanjutnya ‚Üí
                    </button>
                </div>
                
                <button id="finishBtn" class="hidden px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                    Selesai
                </button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-2xl animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Ujian Selesai!</h1>
                <p class="text-gray-600">Hasil ujian Anda telah tersimpan</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="finalScore">0</div>
                        <div class="text-blue-800 font-medium">Skor</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600" id="finalGrade">0</div>
                        <div class="text-green-800 font-medium">Nilai</div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-6 mb-6">
                <h3 class="font-semibold text-gray-800 mb-4">Detail Hasil:</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Nama:</span>
                        <span class="font-medium ml-2" id="resultName">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Kelas:</span>
                        <span class="font-medium ml-2" id="resultClass">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ujian:</span>
                        <span class="font-medium ml-2" id="resultExam">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Waktu:</span>
                        <span class="font-medium ml-2" id="resultTime">-</span>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button onclick="location.reload()" 
                        class="px-8 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                    Kembali ke Login
                </button>
            </div>
        </div>
    </div>

    <!-- Apps Script Code Modal -->
    <div id="appsScriptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üìù Kode Apps Script Baru</h2>
                    <button onclick="document.getElementById('appsScriptModal').style.display='none'" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                </div>
                
                <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="text-sm text-red-800">
                            <div class="font-medium">‚ùå Database Tidak Terhubung</div>
                            <div>Silakan setup Apps Script terlebih dahulu</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-100 p-4 rounded-lg mb-4">
                    <h3 class="font-semibold mb-2">üöÄ Langkah Setup:</h3>
                    <ol class="text-sm space-y-1 list-decimal list-inside">
                        <li>Buka <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a></li>
                        <li>Klik "New Project"</li>
                        <li>Hapus kode default, paste kode di bawah</li>
                        <li>Ganti SPREADSHEET_ID dengan ID Google Sheets Anda</li>
                        <li>Klik "Deploy" ‚Üí "New Deployment"</li>
                        <li>Type: "Web app", Execute as: "Me", Access: "Anyone"</li>
                        <li>Copy Web App URL dan update di kode HTML</li>
                        <li>Jalankan function setupDatabase() sekali</li>
                    </ol>
                </div>
                
                <div class="relative">
                    <button onclick="copyAppsScriptCode()" class="absolute top-2 right-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        üìã Copy
                    </button>
                    <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto" style="max-height: 400px;"><code id="appsScriptCode">// ===== KODE APPS SCRIPT UJIAN ONLINE - VERSI BARU =====
// Paste kode ini ke Google Apps Script

// KONFIGURASI - WAJIB DIGANTI!
const SPREADSHEET_ID = 'GANTI_DENGAN_SPREADSHEET_ID_ANDA';

/**
 * Fungsi utama untuk menangani request dari web app
 */
function doPost(e) {
  try {
    console.log('=== INCOMING REQUEST ===');
    console.log('Raw request:', e);
    
    // Parse request body
    let requestData;
    try {
      const requestBody = e.postData.contents;
      console.log('Request body:', requestBody);
      requestData = JSON.parse(requestBody);
      console.log('Parsed request:', requestData);
    } catch (parseError) {
      console.error('JSON Parse Error:', parseError);
      return createResponse({
        success: false,
        message: 'Invalid JSON format: ' + parseError.message
      });
    }
    
    // Route berdasarkan action
    let result;
    switch (requestData.action) {
      case 'test':
        result = handleTest();
        break;
      case 'authenticate':
        result = handleAuthenticate(requestData.userId, requestData.password);
        break;
      case 'getExamData':
        result = handleGetExamData(requestData.userId);
        break;
      case 'saveResponse':
        result = handleSaveResponse(requestData.responseData);
        break;
      default:
        result = {
          success: false,
          message: 'Unknown action: ' + requestData.action
        };
    }
    
    console.log('=== SENDING RESPONSE ===');
    console.log('Response:', result);
    
    return createResponse(result);
    
  } catch (error) {
    console.error('=== FATAL ERROR ===');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return createResponse({
      success: false,
      message: 'Server error: ' + error.message,
      error: error.toString(),
      stack: error.stack
    });
  }
}

/**
 * Membuat response dengan header yang benar
 */
function createResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

/**
 * Test koneksi database
 */
function handleTest() {
  try {
    console.log('Testing database connection...');
    console.log('Spreadsheet ID:', SPREADSHEET_ID);
    
    if (SPREADSHEET_ID === 'GANTI_DENGAN_SPREADSHEET_ID_ANDA') {
      return {
        success: false,
        message: 'SPREADSHEET_ID belum diganti! Edit kode Apps Script dan ganti dengan ID Spreadsheet Anda.'
      };
    }
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const spreadsheetName = ss.getName();
    const timestamp = new Date().toISOString();
    
    console.log('Database connection successful');
    console.log('Spreadsheet name:', spreadsheetName);
    
    return {
      success: true,
      message: 'Database connection successful',
      data: {
        timestamp: timestamp,
        spreadsheetName: spreadsheetName,
        spreadsheetId: SPREADSHEET_ID
      }
    };
    
  } catch (error) {
    console.error('Database test failed:', error);
    return {
      success: false,
      message: 'Database connection failed: ' + error.message,
      error: error.toString()
    };
  }
}

/**
 * Autentikasi user
 */
function handleAuthenticate(userId, password) {
  try {
    console.log('Authenticating user:', userId);
    
    if (!userId || !password) {
      return {
        success: false,
        message: 'User ID dan Password harus diisi'
      };
    }
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const studentsSheet = ss.getSheetByName('Students');
    
    if (!studentsSheet) {
      return {
        success: false,
        message: 'Sheet Students tidak ditemukan. Jalankan setupDatabase() terlebih dahulu.'
      };
    }
    
    const data = studentsSheet.getDataRange().getValues();
    console.log('Students data rows:', data.length);
    
    // Cari user (skip header row)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      console.log('Checking row:', i, 'UserId:', row[0], 'Password:', row[1]);
      
      if (row[0] === userId && row[1] === password) {
        console.log('Authentication successful for:', userId);
        return {
          success: true,
          message: 'Authentication successful',
          data: {
            userId: row[0],
            name: row[2],
            class: row[3]
          }
        };
      }
    }
    
    console.log('Authentication failed for:', userId);
    return {
      success: false,
      message: 'User ID atau Password salah'
    };
    
  } catch (error) {
    console.error('Authentication error:', error);
    return {
      success: false,
      message: 'Authentication failed: ' + error.message,
      error: error.toString()
    };
  }
}

/**
 * Ambil data ujian dan soal
 */
function handleGetExamData(userId) {
  try {
    console.log('Getting exam data for user:', userId);
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Ambil data ujian
    const examSheet = ss.getSheetByName('Exam');
    if (!examSheet) {
      return {
        success: false,
        message: 'Sheet Exam tidak ditemukan'
      };
    }
    
    const examData = examSheet.getDataRange().getValues();
    if (examData.length < 2) {
      return {
        success: false,
        message: 'Data ujian tidak ditemukan'
      };
    }
    
    const examRow = examData[1]; // Ambil baris pertama data (skip header)
    const exam = {
      id: examRow[0],
      name: examRow[1],
      subject: examRow[2],
      material: examRow[3],
      class: examRow[4],
      date: examRow[5],
      time: examRow[6],
      duration: examRow[7],
      status: examRow[8]
    };
    
    console.log('Exam data:', exam);
    
    // Ambil data soal
    const questionsSheet = ss.getSheetByName('Questions');
    if (!questionsSheet) {
      return {
        success: false,
        message: 'Sheet Questions tidak ditemukan'
      };
    }
    
    const questionsData = questionsSheet.getDataRange().getValues();
    const questions = [];
    
    // Skip header row
    for (let i = 1; i < questionsData.length; i++) {
      const row = questionsData[i];
      if (row[0]) { // Skip empty rows
        questions.push({
          id: row[0],
          examId: row[1],
          type: row[2],
          score: row[3],
          question: row[4],
          optionA: row[5],
          optionB: row[6],
          optionC: row[7],
          optionD: row[8],
          key: row[9]
        });
      }
    }
    
    console.log('Questions loaded:', questions.length);
    
    return {
      success: true,
      message: 'Exam data loaded successfully',
      data: {
        exam: exam,
        questions: questions
      }
    };
    
  } catch (error) {
    console.error('Get exam data error:', error);
    return {
      success: false,
      message: 'Failed to load exam data: ' + error.message,
      error: error.toString()
    };
  }
}

/**
 * Simpan jawaban ujian
 */
function handleSaveResponse(responseData) {
  try {
    console.log('Saving response for user:', responseData.userId);
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let responseSheet = ss.getSheetByName('Responses');
    
    // Buat sheet jika belum ada
    if (!responseSheet) {
      console.log('Creating Responses sheet...');
      responseSheet = ss.insertSheet('Responses');
      
      // Tambah header
      const headers = [
        'Timestamp', 'UserId', 'Name', 'Class', 'ExamId', 'ExamName', 
        'Score', 'MaxScore', 'Grade', 'Status'
      ];
      
      // Tambah kolom Q1-Q30
      for (let i = 1; i <= 30; i++) {
        headers.push(`Q${i}`);
      }
      
      responseSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      console.log('Response sheet created with headers');
    }
    
    // Siapkan data baris
    const rowData = [
      responseData.timestamp,
      responseData.userId,
      responseData.name,
      responseData.class,
      responseData.examId,
      responseData.examName,
      responseData.score,
      responseData.maxScore,
      responseData.grade,
      responseData.status
    ];
    
    // Tambah jawaban Q1-Q30
    for (let i = 1; i <= 30; i++) {
      rowData.push(responseData[`Q${i}`] || '');
    }
    
    // Tambah ke sheet
    responseSheet.appendRow(rowData);
    console.log('Response saved successfully');
    
    return {
      success: true,
      message: 'Response saved successfully'
    };
    
  } catch (error) {
    console.error('Save response error:', error);
    return {
      success: false,
      message: 'Failed to save response: ' + error.message,
      error: error.toString()
    };
  }
}

/**
 * Setup database - Jalankan sekali untuk membuat struktur
 */
function setupDatabase() {
  try {
    console.log('=== SETTING UP DATABASE ===');
    
    if (SPREADSHEET_ID === 'GANTI_DENGAN_SPREADSHEET_ID_ANDA') {
      throw new Error('SPREADSHEET_ID belum diganti! Edit kode dan ganti dengan ID Spreadsheet Anda.');
    }
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('Spreadsheet opened:', ss.getName());
    
    // 1. Setup Students sheet
    console.log('Setting up Students sheet...');
    let studentsSheet = ss.getSheetByName('Students');
    if (studentsSheet) {
      ss.deleteSheet(studentsSheet);
    }
    studentsSheet = ss.insertSheet('Students');
    
    const studentsHeaders = ['UserId', 'Password', 'Name', 'Class'];
    const studentsData = [
      ['admin', 'admin123', 'Administrator', 'Admin'],
      ['guru1', 'guru123', 'Pak Ahmad', 'Guru'],
      ['siswa1', 'siswa123', 'Ahmad Rizki', 'XII IPA 1'],
      ['siswa2', 'siswa123', 'Siti Nurhaliza', 'XII IPA 1'],
      ['siswa3', 'siswa123', 'Budi Santoso', 'XII IPA 2'],
      ['siswa4', 'siswa123', 'Dewi Sartika', 'XII IPA 2']
    ];
    
    studentsSheet.getRange(1, 1, 1, studentsHeaders.length).setValues([studentsHeaders]);
    studentsSheet.getRange(2, 1, studentsData.length, studentsData[0].length).setValues(studentsData);
    console.log('Students sheet created with', studentsData.length, 'users');
    
    // 2. Setup Exam sheet
    console.log('Setting up Exam sheet...');
    let examSheet = ss.getSheetByName('Exam');
    if (examSheet) {
      ss.deleteSheet(examSheet);
    }
    examSheet = ss.insertSheet('Exam');
    
    const examHeaders = ['Id', 'Name', 'Subject', 'Material', 'Class', 'Date', 'Time', 'Duration', 'Status'];
    const examData = [
      [1, 'Ujian Matematika Semester 1', 'Matematika', 'Integral dan Diferensial', 'XII IPA', '2024-01-15', '08:00', 90, 'active']
    ];
    
    examSheet.getRange(1, 1, 1, examHeaders.length).setValues([examHeaders]);
    examSheet.getRange(2, 1, examData.length, examData[0].length).setValues(examData);
    console.log('Exam sheet created');
    
    // 3. Setup Questions sheet
    console.log('Setting up Questions sheet...');
    let questionsSheet = ss.getSheetByName('Questions');
    if (questionsSheet) {
      ss.deleteSheet(questionsSheet);
    }
    questionsSheet = ss.insertSheet('Questions');
    
    const questionsHeaders = ['Id', 'ExamId', 'Type', 'Score', 'Question', 'OptionA', 'OptionB', 'OptionC', 'OptionD', 'Key'];
    const questionsData = [
      [1, 1, 'PG', 10, 'Hasil dari integral ‚à´2x dx adalah...', 'x¬≤ + C', '2x¬≤ + C', 'x¬≤/2 + C', '2x + C', 'A'],
      [2, 1, 'PG', 10, 'Turunan dari f(x) = 3x¬≤ + 2x - 1 adalah...', '6x + 2', '3x + 2', '6x - 1', '3x¬≤ + 2', 'A'],
      [3, 1, 'PG', 10, 'Nilai limit dari lim(x‚Üí2) (x¬≤ - 4)/(x - 2) adalah...', '0', '2', '4', '‚àû', 'C'],
      [4, 1, 'PG', 10, 'Hasil dari ‚à´(3x¬≤ + 2x) dx adalah...', 'x¬≥ + x¬≤ + C', '6x + 2 + C', '3x¬≥ + x¬≤ + C', 'x¬≥ + 2x¬≤ + C', 'A'],
      [5, 1, 'PG', 10, 'Fungsi f(x) = x¬≥ - 3x¬≤ + 2x memiliki titik stasioner di...', 'x = 1', 'x = 2', 'x = 1 dan x = 2/3', 'x = 0', 'C'],
      [6, 1, 'PJ', 15, 'Manakah dari berikut ini yang merupakan bilangan prima? (Pilih semua yang benar)', '17', '21', '23', '25', 'A,C'],
      [7, 1, 'PJ', 20, 'Sifat-sifat fungsi kuadrat f(x) = ax¬≤ + bx + c dengan a > 0 adalah... (Pilih semua yang benar)', 'Grafik membuka ke atas', 'Memiliki nilai minimum', 'Grafik membuka ke bawah', 'Memiliki sumbu simetri', 'A,B,D'],
      [8, 1, 'PJ', 15, 'Operasi berikut yang menghasilkan turunan adalah... (Pilih semua yang benar)', 'Diferensiasi', 'Integrasi', 'Derivasi', 'Substitusi', 'A,C']
    ];
    
    questionsSheet.getRange(1, 1, 1, questionsHeaders.length).setValues([questionsHeaders]);
    questionsSheet.getRange(2, 1, questionsData.length, questionsData[0].length).setValues(questionsData);
    console.log('Questions sheet created with', questionsData.length, 'questions');
    
    console.log('=== DATABASE SETUP COMPLETED ===');
    console.log('‚úÖ Students sheet: ' + studentsData.length + ' users');
    console.log('‚úÖ Exam sheet: ' + examData.length + ' exam');
    console.log('‚úÖ Questions sheet: ' + questionsData.length + ' questions');
    console.log('');
    console.log('üéØ Test login credentials:');
    console.log('   Admin: admin / admin123');
    console.log('   Guru: guru1 / guru123');
    console.log('   Siswa: siswa1 / siswa123');
    
    return 'Database setup completed successfully!';
    
  } catch (error) {
    console.error('=== DATABASE SETUP FAILED ===');
    console.error('Error:', error);
    throw error;
  }
}

/**
 * Fungsi untuk testing manual - jalankan di Apps Script editor
 */
function testManual() {
  console.log('=== MANUAL TESTING ===');
  
  try {
    // Test 1: Setup database
    console.log('1. Testing setupDatabase...');
    setupDatabase();
    console.log('‚úÖ setupDatabase: SUCCESS');
    
    // Test 2: Test connection
    console.log('2. Testing connection...');
    const testResult = handleTest();
    console.log('testConnection result:', testResult);
    
    // Test 3: Test authentication
    console.log('3. Testing authentication...');
    const authResult = handleAuthenticate('siswa1', 'siswa123');
    console.log('authenticateUser result:', authResult);
    
    // Test 4: Test get exam data
    console.log('4. Testing getExamData...');
    const examResult = handleGetExamData('siswa1');
    console.log('getExamData result:', examResult);
    
    console.log('=== ALL TESTS COMPLETED ===');
    
  } catch (error) {
    console.error('=== TESTING FAILED ===');
    console.error('Error:', error);
  }
}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - WAJIB DIGANTI!
        const CONFIG = {
            WEB_APP_URL: 'GANTI_DENGAN_WEB_APP_URL_ANDA',
            SPREADSHEET_ID: 'GANTI_DENGAN_SPREADSHEET_ID_ANDA'
        };

        // Global variables
        let currentUser = null;
        let currentExam = null;
        let questions = [];
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let markedQuestions = new Set();
        let examTimer = null;
        let timeRemaining = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            testDatabaseConnection();
        });

        function setupEventListeners() {
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('prevBtn').addEventListener('click', previousQuestion);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('markBtn').addEventListener('click', toggleMark);
            document.getElementById('finishBtn').addEventListener('click', finishExam);
        }

        async function testDatabaseConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            // Check if URLs are configured
            if (CONFIG.WEB_APP_URL === 'GANTI_DENGAN_WEB_APP_URL_ANDA') {
                showSetupRequired();
                return;
            }
            
            // Show testing status
            statusDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <div class="text-sm text-blue-800">
                        <div class="font-medium">üîç Menguji Koneksi Database...</div>
                        <div>Mengirim request ke Apps Script...</div>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Success
                    statusDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4';
                    statusDiv.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-green-800">
                                <div class="font-medium">‚úÖ Database Terhubung</div>
                                <div>Spreadsheet: ${result.data.spreadsheetName}</div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Database connection failed:', error);
                showSetupRequired();
            }
        }

        function showSetupRequired() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-4';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="text-sm text-red-800">
                        <div class="font-medium">‚ùå Setup Apps Script Diperlukan</div>
                        <div>Klik tombol di bawah untuk melihat kode</div>
                    </div>
                </div>
            `;
            
            // Show modal automatically
            document.getElementById('appsScriptModal').style.display = 'flex';
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (CONFIG.WEB_APP_URL === 'GANTI_DENGAN_WEB_APP_URL_ANDA') {
                showError('Apps Script belum di-setup! Silakan setup terlebih dahulu.');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Memuat...';
            submitBtn.disabled = true;

            try {
                // Authenticate user
                const authResponse = await fetch(CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'authenticate',
                        userId: userId,
                        password: password
                    })
                });
                
                const authResult = await authResponse.json();
                
                if (!authResult.success) {
                    showError(authResult.message);
                    return;
                }
                
                currentUser = authResult.data;
                
                // Load exam data
                const examResponse = await fetch(CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getExamData',
                        userId: userId
                    })
                });
                
                const examResult = await examResponse.json();
                
                if (!examResult.success) {
                    showError(examResult.message);
                    return;
                }
                
                currentExam = examResult.data.exam;
                questions = examResult.data.questions;
                shuffledQuestions = shuffleQuestionsByType(questions);
                timeRemaining = currentExam.duration * 60;
                
                showQuizInterface();
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Terjadi kesalahan koneksi. Pastikan Apps Script sudah di-deploy dengan benar.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function shuffleQuestionsByType(questions) {
            // Group by type
            const questionsByType = {};
            questions.forEach(q => {
                if (!questionsByType[q.type]) {
                    questionsByType[q.type] = [];
                }
                questionsByType[q.type].push(q);
            });

            // Shuffle within each type
            let shuffled = [];
            Object.keys(questionsByType).forEach(type => {
                const typeQuestions = questionsByType[type];
                for (let i = typeQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [typeQuestions[i], typeQuestions[j]] = [typeQuestions[j], typeQuestions[i]];
                }
                shuffled = shuffled.concat(typeQuestions);
            });

            // Shuffle options for each question
            shuffled.forEach(q => {
                const options = [
                    { key: 'A', text: q.optionA },
                    { key: 'B', text: q.optionB },
                    { key: 'C', text: q.optionC },
                    { key: 'D', text: q.optionD }
                ];
                
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }
                
                q.shuffledOptions = options;
            });

            return shuffled;
        }

        function showQuizInterface() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('quizInterface').classList.remove('hidden');
            
            document.getElementById('examTitle').textContent = 
                `${currentExam.name} - ${currentExam.subject} - ${currentExam.class}`;
            document.getElementById('examSubtitle').textContent = currentExam.material;
            
            startTimer();
            showQuestion(0);
        }

        function startTimer() {
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    finishExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showQuestion(index) {
            if (index < 0 || index >= shuffledQuestions.length) return;
            
            currentQuestionIndex = index;
            const question = shuffledQuestions[index];
            
            document.getElementById('questionType').textContent = question.type;
            document.getElementById('questionNumber').textContent = `Soal ${index + 1}`;
            document.getElementById('questionText').textContent = question.question;
            
            document.getElementById('questionCounter').textContent = `${index + 1}/${shuffledQuestions.length}`;
            const progress = ((index + 1) / shuffledQuestions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            
            showOptions(question);
            
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', index === shuffledQuestions.length - 1);
            document.getElementById('finishBtn').classList.toggle('hidden', index !== shuffledQuestions.length - 1);
            
            const markBtn = document.getElementById('markBtn');
            if (markedQuestions.has(question.id)) {
                markBtn.textContent = 'üè∑Ô∏è Ditandai';
                markBtn.classList.add('bg-yellow-600');
            } else {
                markBtn.textContent = 'üè∑Ô∏è Tandai';
                markBtn.classList.remove('bg-yellow-600');
            }
        }

        function showOptions(question) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            if (question.type === 'PJ') {
                const instruction = document.createElement('div');
                instruction.className = 'mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg';
                instruction.innerHTML = `
                    <div class="flex items-center text-yellow-800">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium">Pilihan Jamak: Anda dapat memilih lebih dari satu jawaban</span>
                    </div>
                `;
                container.appendChild(instruction);
            }
            
            question.shuffledOptions.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-hover cursor-pointer p-4 border-2 border-gray-200 rounded-lg transition-all duration-200 hover:border-primary hover:bg-blue-50';
                
                let isSelected = false;
                if (question.type === 'PG') {
                    isSelected = userAnswers[question.id] === option.key;
                } else if (question.type === 'PJ') {
                    const selectedAnswers = userAnswers[question.id] ? userAnswers[question.id].split(',') : [];
                    isSelected = selectedAnswers.includes(option.key);
                }
                
                if (isSelected) {
                    optionDiv.classList.add('border-primary', 'bg-blue-50');
                }
                
                const inputShape = question.type === 'PG' ? 'rounded-full' : 'rounded';
                
                optionDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 ${inputShape} border-2 ${isSelected ? 'border-primary bg-primary' : 'border-gray-300'} flex items-center justify-center mr-3">
                            ${isSelected ? (question.type === 'PG' ? '<div class="w-3 h-3 bg-white rounded-full"></div>' : '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>') : ''}
                        </div>
                        <span class="font-medium text-gray-700 mr-2">${option.key}.</span>
                        <span class="text-gray-800">${option.text}</span>
                    </div>
                `;
                
                optionDiv.addEventListener('click', () => selectOption(question.id, option.key, question.type));
                container.appendChild(optionDiv);
            });
        }

        function selectOption(questionId, optionKey, questionType) {
            if (questionType === 'PG') {
                userAnswers[questionId] = optionKey;
            } else if (questionType === 'PJ') {
                const currentAnswers = userAnswers[questionId] ? userAnswers[questionId].split(',') : [];
                const index = currentAnswers.indexOf(optionKey);
                
                if (index > -1) {
                    currentAnswers.splice(index, 1);
                } else {
                    currentAnswers.push(optionKey);
                }
                
                currentAnswers.sort();
                userAnswers[questionId] = currentAnswers.length > 0 ? currentAnswers.join(',') : '';
            }
            
            showQuestion(currentQuestionIndex);
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < shuffledQuestions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        }

        function toggleMark() {
            const question = shuffledQuestions[currentQuestionIndex];
            if (markedQuestions.has(question.id)) {
                markedQuestions.delete(question.id);
            } else {
                markedQuestions.add(question.id);
            }
            showQuestion(currentQuestionIndex);
        }

        async function finishExam() {
            if (examTimer) {
                clearInterval(examTimer);
            }
            
            // Calculate score
            let totalScore = 0;
            let maxPossibleScore = 0;
            
            shuffledQuestions.forEach(question => {
                maxPossibleScore += question.score;
                
                const userAnswer = userAnswers[question.id] || '';
                const correctAnswer = question.key;
                
                if (question.type === 'PG') {
                    if (userAnswer === correctAnswer) {
                        totalScore += question.score;
                    }
                } else if (question.type === 'PJ') {
                    const userAnswerArray = userAnswer ? userAnswer.split(',').sort() : [];
                    const correctAnswerArray = correctAnswer.split(',').sort();
                    
                    if (userAnswerArray.length === 0) {
                        totalScore += 0;
                    } else if (userAnswerArray.join(',') === correctAnswerArray.join(',')) {
                        totalScore += question.score;
                    } else {
                        let correctSelections = 0;
                        let incorrectSelections = 0;
                        
                        userAnswerArray.forEach(answer => {
                            if (correctAnswerArray.includes(answer)) {
                                correctSelections++;
                            } else {
                                incorrectSelections++;
                            }
                        });
                        
                        const partialScore = Math.max(0, (correctSelections - incorrectSelections) / correctAnswerArray.length * question.score);
                        totalScore += Math.round(partialScore);
                    }
                }
            });
            
            const grade = Math.round((totalScore / maxPossibleScore) * 100);
            
            // Prepare response data
            const responseData = {
                timestamp: new Date().toISOString(),
                userId: currentUser.userId,
                name: currentUser.name,
                class: currentUser.class,
                examId: currentExam.id,
                examName: currentExam.name,
                score: totalScore,
                maxScore: maxPossibleScore,
                grade: grade,
                status: 'completed'
            };
            
            // Add answers Q1-Q30
            for (let i = 1; i <= 30; i++) {
                const originalQuestion = questions.find(q => q.id === i);
                if (originalQuestion) {
                    responseData[`Q${i}`] = userAnswers[originalQuestion.id] || '';
                } else {
                    responseData[`Q${i}`] = '';
                }
            }
            
            // Save to database
            try {
                await fetch(CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'saveResponse',
                        responseData: responseData
                    })
                });
            } catch (error) {
                console.error('Failed to save response:', error);
            }
            
            showResults(responseData);
        }

        function showResults(responseData) {
            document.getElementById('quizInterface').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = `${responseData.score}/${responseData.maxScore}`;
            document.getElementById('finalGrade').textContent = responseData.grade;
            document.getElementById('resultName').textContent = responseData.name;
            document.getElementById('resultClass').textContent = responseData.class;
            document.getElementById('resultExam').textContent = responseData.examName;
            document.getElementById('resultTime').textContent = new Date().toLocaleString('id-ID');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function copyAppsScriptCode() {
            const code = document.getElementById('appsScriptCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Kode Apps Script berhasil di-copy!\n\nLangkah selanjutnya:\n1. Buka script.google.com\n2. Buat project baru\n3. Paste kode ini\n4. Ganti SPREADSHEET_ID\n5. Deploy sebagai Web App');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Kode berhasil di-copy!');
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d6465462759fc7',t:'MTc1NDkwMDAxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
